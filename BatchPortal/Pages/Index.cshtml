@page
@model BatchPortal.Pages.IndexModel
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
    ViewData["Title"] = "Batch Inference Dashboard";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Batch Inference Dashboard</h1>
    <div class="btn-group" role="group">
        <a asp-page="/Batches/Index" class="btn btn-primary">
            <i class="bi bi-grid-3x3-gap-fill me-1"></i> View All Batches
        </a>
        <a href="@Configuration["Monitoring:GrafanaUrl"]" target="_blank" class="btn btn-outline-secondary" rel="noopener noreferrer">
            <i class="bi bi-graph-up me-1"></i> Monitoring
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title text-muted mb-1">Total Batches</h5>
                        <p class="display-6 mb-0">@Model.Dashboard.TotalBatches</p>
                    </div>
                    <div class="stat-icon bg-primary-subtle">
                        <i class="bi bi-layers-fill text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title text-muted mb-1">Completed (24h)</h5>
                        <p class="display-6 text-success mb-0">@Model.Dashboard.CompletedLast24h</p>
                    </div>
                    <div class="stat-icon bg-success-subtle">
                        <i class="bi bi-check-circle-fill text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title text-muted mb-1">Failed (24h)</h5>
                        <p class="display-6 text-danger mb-0">@Model.Dashboard.FailedLast24h</p>
                    </div>
                    <div class="stat-icon bg-danger-subtle">
                        <i class="bi bi-x-circle-fill text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title text-muted mb-1">In Progress</h5>
                        <p class="display-6 text-warning mb-0">@Model.Dashboard.InProgress</p>
                    </div>
                    <div class="stat-icon bg-warning-subtle">
                        <i class="bi bi-hourglass-split text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<h2>Recent Batches</h2>
@if (!Model.Dashboard.RecentBatches.Any())
{
    <div class="empty-state text-center py-5">
        <i class="bi bi-inbox display-1 text-muted mb-3"></i>
        <h3 class="text-muted">No batches found</h3>
        <p class="text-muted mb-4">Get started by creating your first batch inference job.</p>
        <a asp-page="/Batches/Index" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> View Batches Page
        </a>
    </div>
}
else
{
    <table class="table table-hover mb-4">
        <thead>
            <tr>
                <th>Created</th>
                <th>User</th>
                <th>Status</th>
                <th>GPU Pool</th>
                <th>Progress</th>
                <th>SLA</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        @foreach (var b in Model.Dashboard.RecentBatches)
        {
            var totalRequests = b.TotalRequests > 0 ? b.TotalRequests : 1;
            var completedRequests = b.CompletedRequests;
            var progressPercent = (int)((completedRequests / (double)totalRequests) * 100);
            
            <tr>
                <td>@b.CreatedAt.Humanize()</td>
                <td>@b.UserId</td>
                <td>
                    @{
                        var statusIcon = b.Status switch {
                            "Queued" => "pause-circle",
                            "Running" => "play-circle-fill",
                            "Completed" => "check-circle-fill",
                            "Failed" => "x-circle-fill",
                            "Cancelled" => "slash-circle",
                            "DeadLettered" => "exclamation-triangle-fill",
                            _ => null
                        };
                    }
                    @if (statusIcon != null)
                    {
                        <i class="bi bi-@statusIcon me-1"></i>
                    }
                    @await Html.PartialAsync("Components/Ui/StatusBadge", b.Status)
                </td>
                <td>@await Html.PartialAsync("Components/Ui/GpuPoolBadge", b.GpuPool)</td>
                <td style="min-width: 150px;">
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar @(progressPercent == 100 ? "bg-success" : "")" 
                             role="progressbar" 
                             style="width: @progressPercent%" 
                             aria-valuenow="@progressPercent" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            @completedRequests/@totalRequests
                        </div>
                    </div>
                </td>
                <td>
                    @if (!b.CompletedAt.HasValue)
                    {
                        <span class="badge bg-warning">In progress</span>
                    }
                    else if (b.IsSlaBreached)
                    {
                        <span class="badge bg-danger">Breached</span>
                    }
                    else
                    {
                        <span class="badge bg-success">Met</span>
                    }
                </td>
                <td>
                    <a asp-page="/Batches/Details" asp-route-id="@b.Id" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-right-circle me-1"></i> Details
                    </a>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

<h2>System Health</h2>
<ul>
    <li>
        Database:
        @if (Model.Dashboard.DbHealthy)
        {
            <span class="badge bg-success">Healthy</span>
        }
        else
        {
            <span class="badge bg-danger">Unreachable</span>
        }
    </li>
    <li>
        API Gateway:
        @if (Model.Dashboard.ApiGatewayHealthy)
        {
            <span class="badge bg-success">Healthy</span>
        }
        else
        {
            <span class="badge bg-warning">Unknown</span>
        }
    </li>
</ul>
