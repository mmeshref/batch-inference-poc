@page
@model BatchPortal.Pages.Batches.DetailsModel
@{
    ViewData["Title"] = "Batch Details";
}

@if (Model.Batch is null)
{
    <div class="alert alert-danger">Batch not found.</div>
    return;
}

<h1>Batch Details</h1>

<div class="card mb-3">
    <div class="card-body">
        <h2 class="card-title">Batch <code class="monospaced">@Model.Batch.Id</code></h2>
        <p class="card-text mb-2">
            User: <strong>@Model.Batch.UserId</strong><br />
            Status: <status-badge value="@Model.Batch.Status"></status-badge><br />
            GPU Pool: <pool-badge value="@Model.Batch.GpuPool"></pool-badge>
        </p>
        <div class="row">
            <div class="col-md-6">
                <p class="card-text mb-2">
                    Created: @Model.Batch.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")<br />
                    Started: @(Model.Batch.StartedAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "—")<br />
                    Completed: @(Model.Batch.CompletedAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "—")<br />
                    SLA deadline: @Model.Batch.SlaDeadline.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                </p>
            </div>
            <div class="col-md-6">
                <p class="card-text mb-2">
                    SLA status:
                    @if (Model.Batch.CompletedAt is null)
                    {
                        <span class="badge badge-sm bg-warning text-dark">In progress</span>
                    }
                    else if (Model.Batch.IsSlaBreached)
                    {
                        <span class="badge badge-sm bg-danger">Breached</span>
                    }
                    else
                    {
                        <span class="badge badge-sm bg-success">Met</span>
                    }
                </p>
                <p class="card-text mb-0">
                    Requests:
                    <strong>@Model.Batch.TotalRequests</strong> total
                    (Queued: @Model.Batch.QueuedCount,
                    Running: @Model.Batch.RunningCount,
                    Completed: @Model.Batch.CompletedCount,
                    Failed: @Model.Batch.FailedCount)
                </p>
            </div>
        </div>
    </div>
</div>

<div class="timeline mb-4">
    <h3 class="section-title">Timeline</h3>
    <div class="timeline-steps">
        <div class="timeline-step">
            <div class="timeline-dot timeline-dot-ok"></div>
            <div class="timeline-label">
                <strong>Created</strong><br />
                @Model.Batch.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
            </div>
        </div>
        <div class="timeline-step">
            <div class="timeline-dot @(Model.Batch.StartedAt.HasValue ? "timeline-dot-ok" : string.Empty)"></div>
            <div class="timeline-label">
                <strong>Started</strong><br />
                @(Model.Batch.StartedAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "Pending")
            </div>
        </div>
        <div class="timeline-step">
            <div class="@(Model.Batch.CompletedAt.HasValue
                ? (Model.Batch.IsSlaBreached ? "timeline-dot timeline-dot-danger" : "timeline-dot timeline-dot-ok")
                : "timeline-dot")"></div>
            <div class="timeline-label">
                <strong>Completed</strong><br />
                @(Model.Batch.CompletedAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "In progress")
            </div>
        </div>
        <div class="timeline-step">
            <div class="timeline-dot @(Model.Batch.IsSlaBreached ? "timeline-dot-danger" : "timeline-dot-ok")"></div>
            <div class="timeline-label">
                <strong>SLA deadline</strong><br />
                @Model.Batch.SlaDeadline.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
            </div>
        </div>
    </div>
</div>

<h3 class="section-title">Requests</h3>
<div class="mb-2">
    <span>Filter:</span>
    <a asp-page="./Details" asp-route-id="@Model.Batch.Id" class="me-2 @(Model.StatusFilter is null ? "fw-bold" : string.Empty)">All</a>
    @foreach (var status in Model.AvailableStatuses)
    {
        <a asp-page="./Details"
           asp-route-id="@Model.Batch.Id"
           asp-route-status="@status"
           class="me-2 @(string.Equals(Model.StatusFilter, status, StringComparison.OrdinalIgnoreCase) ? "fw-bold" : string.Empty)">
            @status
        </a>
    }
</div>

<table class="table table-sm table-striped align-middle">
    <thead>
        <tr>
            <th>Request ID</th>
            <th>Status</th>
            <th>GPU Pool</th>
            <th>Created</th>
            <th>Completed</th>
            <th>Error</th>
        </tr>
    </thead>
    <tbody>
    @if (!Model.Requests.Any())
    {
        <tr>
            <td colspan="6" class="text-center">No requests found with this filter.</td>
        </tr>
    }
    else
    {
        foreach (var request in Model.Requests)
        {
            <tr>
                <td><code class="monospaced">@request.Id</code></td>
                <td><status-badge value="@request.Status"></status-badge></td>
                <td><pool-badge value="@request.GpuPool"></pool-badge></td>
                <td>@request.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
                <td>@(request.CompletedAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "—")</td>
                <td>@(string.IsNullOrEmpty(request.ErrorMessage) ? "—" : request.ErrorMessage)</td>
            </tr>
        }
    }
    </tbody>
</table>

<h3 class="section-title">Interruption / Notes</h3>
@if (!string.IsNullOrWhiteSpace(Model.Batch.Notes))
{
    <p>@Model.Batch.Notes</p>
}
else
{
    <p class="text-muted">No notes recorded for this batch.</p>
}

