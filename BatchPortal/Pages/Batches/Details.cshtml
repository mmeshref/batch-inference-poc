@page
@model BatchPortal.Pages.Batches.DetailsModel

<h1 class="mb-3">Batch <code class="monospaced">@Model.Batch?.Id</code></h1>

@if (Model.Batch is null)
{
    <div class="alert alert-danger">Batch not found.</div>
}
else
{
    <h2 class="section-title">Batch Metadata</h2>
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between flex-wrap gap-2 mb-3">
                <div>
                    <status-badge value="@Model.Batch.Status"></status-badge>
                    <pool-badge value="@Model.Batch.GpuPool" class="ms-2"></pool-badge>
                </div>
                <div class="text-muted">
                    Created @TimeFormatting.ToRelative(Model.Batch.CreatedAt)
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">User</dt>
                        <dd class="col-sm-8">@Model.Batch.UserId</dd>

                        <dt class="col-sm-4">Created</dt>
                        <dd class="col-sm-8">
                            @Model.Batch.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                            <small class="text-muted">(@TimeFormatting.ToRelative(Model.Batch.CreatedAt))</small>
                        </dd>

                        <dt class="col-sm-4">Started</dt>
                        <dd class="col-sm-8">
                            @((Model.Batch.StartedAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")) ?? "-")
                            @if (Model.Batch.StartedAt.HasValue)
                            {
                                <small class="text-muted">(@TimeFormatting.ToRelative(Model.Batch.StartedAt))</small>
                            }
                        </dd>

                        <dt class="col-sm-4">SLA Window</dt>
                        <dd class="col-sm-8">@Model.Batch.CompletionWindow</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Completed</dt>
                        <dd class="col-sm-8">
                            @((Model.Batch.CompletedAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")) ?? "-")
                            @if (Model.Batch.CompletedAt.HasValue)
                            {
                                <small class="text-muted">(@TimeFormatting.ToRelative(Model.Batch.CompletedAt))</small>
                            }
                        </dd>

                        <dt class="col-sm-4">Error</dt>
                        <dd class="col-sm-8">@Model.Batch.ErrorMessage ?? "-"</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <h2 class="section-title">Interruption / Notes</h2>
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            @if (Model.HasEscalatedRequests)
            {
                <div class="alert alert-warning mb-0" role="alert">
                    <strong>Spot â†’ Dedicated escalation detected.</strong>
                    <div>@Model.EscalatedRequestCount request(s) were escalated due to interruption or SLA risk.</div>
                    @if (Model.FirstEscalationAt.HasValue)
                    {
                        <div class="mt-1">
                            First escalation around @Model.FirstEscalationAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                            <small class="text-muted">(@TimeFormatting.ToRelative(Model.FirstEscalationAt))</small>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-secondary mb-0">No interruptions detected for this batch.</div>
            }
        </div>
    </div>

    <h2 class="section-title">Requests (@Model.Requests.Count)</h2>

    <table class="table table-sm table-striped align-middle">
        <thead>
            <tr>
                <th>Line</th>
                <th>Request Id</th>
                <th>Status</th>
                <th>GPU Pool</th>
                <th>Created</th>
                <th>Completed</th>
                <th>Input</th>
                <th>Output</th>
                <th>Error / Notes</th>
            </tr>
        </thead>
        <tbody>
            @if (!Model.Requests.Any())
            {
                <tr>
                    <td colspan="9" class="text-center">No requests yet.</td>
                </tr>
            }
            else
            {
                foreach (var request in Model.Requests)
                {
                    <tr>
                        <td>@request.LineNumber</td>
                        <td><code class="monospaced">@request.Id</code></td>
                        <td><status-badge value="@request.Status"></status-badge></td>
                        <td><pool-badge value="@request.GpuPool"></pool-badge></td>
                        <td>
                            @request.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                            <div class="text-muted small">@TimeFormatting.ToRelative(request.CreatedAt)</div>
                        </td>
                        <td>
                            @if (request.CompletedAt.HasValue)
                            {
                                @request.CompletedAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                                <div class="text-muted small">@TimeFormatting.ToRelative(request.CompletedAt)</div>
                            }
                            else
                            {
                                @("-")
                            }
                        </td>
                        <td>
                            <details>
                                <summary>View</summary>
                                <pre class="mb-0 mt-2">@request.InputPayload</pre>
                            </details>
                        </td>
                        <td>
                            <details>
                                <summary>View</summary>
                                <pre class="mb-0 mt-2">@request.OutputPayload</pre>
                            </details>
                        </td>
                        <td>
                            @if (request.WasRequeuedFromSpot)
                            {
                                <span class="badge bg-warning text-dark badge-sm">
                                    Interrupted on spot, requeued to dedicated
                                </span>
                            }
                            else if (!string.IsNullOrEmpty(request.ErrorMessage))
                            {
                                <span class="text-danger">@request.ErrorMessage</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

