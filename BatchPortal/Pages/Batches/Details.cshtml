@page
@model BatchPortal.Pages.Batches.DetailsModel

<h1>Batch @Model.Batch?.Id</h1>

@if (Model.Batch is null)
{
    <div class="alert alert-danger">Batch not found.</div>
}
else
{
    @if (Model.HasRequeuedRequests)
    {
        <div class="alert alert-warning mt-3">
            Some requests for this batch were interrupted on spot and have been requeued to dedicated GPUs.
        </div>
    }

    <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Batch Metadata</span>
            <div>
                <span class="badge bg-secondary me-2">@Model.Batch.Id</span>
                <span class="badge bg-primary text-uppercase">@Model.Batch.Status</span>
                <span class="badge bg-info text-dark text-uppercase">@Model.Batch.GpuPool</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">User</dt>
                        <dd class="col-sm-8">@Model.Batch.UserId</dd>

                        <dt class="col-sm-4">Created</dt>
                        <dd class="col-sm-8">@Model.Batch.CreatedAt.ToLocalTime().ToString("u")</dd>

                        <dt class="col-sm-4">Started</dt>
                        <dd class="col-sm-8">@Model.Batch.StartedAt?.ToLocalTime().ToString("u") ?? "-"</dd>

                        <dt class="col-sm-4">SLA Window</dt>
                        <dd class="col-sm-8">@Model.Batch.CompletionWindow</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">Completed</dt>
                        <dd class="col-sm-8">@Model.Batch.CompletedAt?.ToLocalTime().ToString("u") ?? "-"</dd>

                        <dt class="col-sm-4">Error</dt>
                        <dd class="col-sm-8">@Model.Batch.ErrorMessage ?? "-"</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <h2>Requests (@Model.Requests.Count)</h2>

    <table class="table table-sm table-striped align-middle">
        <thead>
            <tr>
                <th>Line</th>
                <th>Status</th>
                <th>GPU Pool</th>
                <th>Input</th>
                <th>Output</th>
                <th>Error</th>
                <th>Interruption / Notes</th>
            </tr>
        </thead>
        <tbody>
            @if (!Model.Requests.Any())
            {
                <tr>
                    <td colspan="7" class="text-center">No requests yet.</td>
                </tr>
            }
            else
            {
                foreach (var request in Model.Requests)
                {
                    <tr>
                        <td>@request.LineNumber</td>
                        <td>@request.Status</td>
                        <td>
                            @{
                                var poolBadge = string.Equals(request.GpuPool, "dedicated", StringComparison.OrdinalIgnoreCase)
                                    ? "bg-danger"
                                    : "bg-secondary";
                            }
                            <span class="badge @poolBadge text-uppercase">@request.GpuPool</span>
                        </td>
                        <td>
                            <details>
                                <summary>View</summary>
                                <pre class="mb-0 mt-2">@request.InputPayload</pre>
                            </details>
                        </td>
                        <td>
                            <details>
                                <summary>View</summary>
                                <pre class="mb-0 mt-2">@request.OutputPayload</pre>
                            </details>
                        </td>
                        <td>
                            <details>
                                <summary>View</summary>
                                <pre class="mb-0 mt-2">@request.ErrorMessage</pre>
                            </details>
                        </td>
                        <td>
                            @if (request.WasRequeuedFromSpot)
                            {
                                <span class="badge bg-warning text-dark">
                                    Interrupted on spot, requeued to dedicated
                                </span>
                            }
                            else if (!string.IsNullOrEmpty(request.ErrorMessage))
                            {
                                <span class="text-danger">@request.ErrorMessage</span>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

